---
title:  "CNN 이미지 분류분석 01" 
excerpt: "CNN을 활용하여 이미지 분류분석을 해보자!"

categories:
  - CNN
tags:
  - [CNN, AI, Machine Learning]

toc: true
toc_sticky: true
 
date: 2021-11-06
last_modified_at: 2021-11-06

---



## 1주차 이미지 분석 CNN

- 개와 고양이를 분류하는 이미지 분류 모델을 만들자.

### import 


```python
!pip install --upgrade fastai -q
```

    [K     |████████████████████████████████| 189 kB 4.2 MB/s 
    [K     |████████████████████████████████| 56 kB 4.4 MB/s 
    [?25h


```python
!pip install fastai
```

```python
from fastai.vision.all import *
```

### 데이터저장, 데이터로더스 생성후 dls로 저장 


```python
path=untar_data(URLs.PETS)/'images' # 웹에서 다운 받는것. / 코랩에서는 가상폴더에 저장하는 것 같음. 
```



<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='811712512' class='' max='811706944' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [811712512/811706944 00:50<00:00]
</div>




```python
files=get_image_files(path) # 이미지파일들의 이름을 모두 복붙하여 리스트를 만든뒤에 files.txt로 저장하는 과정
```


```python
files[2] # txt 파일의 3번째 목록
```

파일 이름의 첫글자가 대문자면 고양이 소문자면 강아지임을 알 수 있다.


```python
def label_func(f):
    if f[0].isupper():
        return 'cat' 
    else: 
        return 'dog' 
```


```python
label_func('asdf') 
```


```python
dls=ImageDataLoaders.from_name_func(path,files,label_func,item_tfms=Resize(244)) #데이터들을 분류 분석할 수 있는 함수. 
```

ImageDataLaoders (이미지 불러오기는 함수)  
.from_name_func(이름으로 불러오겠다.)  
안에는 필요한 조건들을 채우는것 

path 경로 / 파일들 이름 / 함수 / 이미지 사이즈 정리


```python
dls.show_batch(max_n=16)
```

### 학습


```python
learn = cnn_learner(dls,resnet34,metrics=error_rate)
```

`-` 에러를 해결하기 위해서는 아래를 설치하면 된다. 


```python
# !conda install -c conda-forge jupyterlab_widgets -y 
# !conda install -c conda-forge ipywidgets -y 
# !conda install -c conda-forge nodejs -y 
```

`-` 위를 설치하고 커널을 재시작하면 정상적으로 모형이 만들어진다. 


```python
learn=cnn_learner(dls,resnet34,metrics=error_rate)
```


```python
learn.fine_tune(1)
```


<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.144466</td>
      <td>0.020612</td>
      <td>0.008119</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table>



<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.062860</td>
      <td>0.018618</td>
      <td>0.005413</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table>


### 예측


```python
learn.predict(files[0])
```








    ('dog', tensor(1), tensor([2.4075e-07, 1.0000e+00]))




```python
learn.show_results()
```






    
![png](output_24_1.png)
    


### 오답분석 


```python
interp = Interpretation.from_learner(learn)
```






```python
interp.plot_top_losses(16)
```


    
![png](output_27_0.png)
    


### 진짜 잘되는게 맞는건가? 


```python
PILImage.create('2021-09-06-cat1.png')
```




    
![png](output_29_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-cat1.png'))
```








    ('cat', tensor(0), tensor([1.0000e+00, 1.0442e-07]))



`-` 헷갈리는 고양이 사진인데 잘 구분한다. 


```python
PILImage.create('2021-09-06-cat2.jpeg')
```




    
![png](output_32_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-cat2.jpeg'))
```








    ('cat', tensor(0), tensor([1.0000e+00, 3.3645e-06]))




```python
PILImage.create('2021-09-06-hani01.jpeg')
```




    
![png](output_34_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani01.jpeg'))
```








    ('dog', tensor(1), tensor([3.1670e-06, 1.0000e+00]))




```python
PILImage.create('2021-09-06-hani02.jpeg')
```




    
![png](output_36_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani02.jpeg'))
```








    ('dog', tensor(1), tensor([8.1501e-06, 9.9999e-01]))




```python
PILImage.create('2021-09-06-hani03.jpg')
```




    
![png](output_38_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani03.jpg'))
```








    ('dog', tensor(1), tensor([0.0270, 0.9730]))



### 다음시간 
- 이미지 크롤링 --> 데이터셋트 --> A,B 구분하는 모델 

### [숙제](https://ieilms.jbnu.ac.kr/)
- 위의 사진들 이외에 사진들을 바탕으로 예측을 하는 모형구축. 
- 예측결과를 스샷으로 저장하여 제출 (이미지도 함께 스샷할것) 

### 숙제참고자료 


```python
import PIL 
urls='https://t1.daumcdn.net/cfile/tistory/9925F03C5AD486B033'
urllib.request.urlretrieve(urls,'temp.png')
learn.predict(PILImage.create('temp.png'))
```








    ('dog', tensor(1), tensor([0.0091, 0.9909]))




```python
jupyter nbconvert --to markdown [2021-11-06-cnn 이미지 분류분석].
```
