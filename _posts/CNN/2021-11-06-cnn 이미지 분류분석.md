## 1ì£¼ì°¨ ì´ë¯¸ì§€ ë¶„ì„ CNN

- ê°œì™€ ê³ ì–‘ì´ë¥¼ ë¶„ë¥˜í•˜ëŠ” ì´ë¯¸ì§€ ë¶„ë¥˜ ëª¨ë¸ì„ ë§Œë“¤ì.

### import 


```python
!pip install --upgrade fastai -q
```

    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 189 kB 4.2 MB/s 
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 56 kB 4.4 MB/s 
    [?25h


```python
!pip install fastai
```

    Requirement already satisfied: fastai in /usr/local/lib/python3.7/dist-packages (2.5.3)
    Requirement already satisfied: pip in /usr/local/lib/python3.7/dist-packages (from fastai) (21.1.3)
    Requirement already satisfied: matplotlib in /usr/local/lib/python3.7/dist-packages (from fastai) (3.2.2)
    Requirement already satisfied: scikit-learn in /usr/local/lib/python3.7/dist-packages (from fastai) (0.22.2.post1)
    Requirement already satisfied: spacy<4 in /usr/local/lib/python3.7/dist-packages (from fastai) (2.2.4)
    Requirement already satisfied: requests in /usr/local/lib/python3.7/dist-packages (from fastai) (2.23.0)
    Requirement already satisfied: fastdownload<2,>=0.0.5 in /usr/local/lib/python3.7/dist-packages (from fastai) (0.0.5)
    Requirement already satisfied: torch<1.11,>=1.7.0 in /usr/local/lib/python3.7/dist-packages (from fastai) (1.9.0+cu111)
    Requirement already satisfied: scipy in /usr/local/lib/python3.7/dist-packages (from fastai) (1.4.1)
    Requirement already satisfied: packaging in /usr/local/lib/python3.7/dist-packages (from fastai) (21.0)
    Requirement already satisfied: pillow>6.0.0 in /usr/local/lib/python3.7/dist-packages (from fastai) (7.1.2)
    Requirement already satisfied: pandas in /usr/local/lib/python3.7/dist-packages (from fastai) (1.1.5)
    Requirement already satisfied: pyyaml in /usr/local/lib/python3.7/dist-packages (from fastai) (3.13)
    Requirement already satisfied: fastprogress>=0.2.4 in /usr/local/lib/python3.7/dist-packages (from fastai) (1.0.0)
    Requirement already satisfied: fastcore<1.4,>=1.3.22 in /usr/local/lib/python3.7/dist-packages (from fastai) (1.3.27)
    Requirement already satisfied: torchvision>=0.8.2 in /usr/local/lib/python3.7/dist-packages (from fastai) (0.10.0+cu111)
    Requirement already satisfied: numpy in /usr/local/lib/python3.7/dist-packages (from fastprogress>=0.2.4->fastai) (1.19.5)
    Requirement already satisfied: cymem<2.1.0,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (2.0.5)
    Requirement already satisfied: catalogue<1.1.0,>=0.0.7 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (1.0.0)
    Requirement already satisfied: tqdm<5.0.0,>=4.38.0 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (4.62.3)
    Requirement already satisfied: blis<0.5.0,>=0.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (0.4.1)
    Requirement already satisfied: preshed<3.1.0,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (3.0.5)
    Requirement already satisfied: wasabi<1.1.0,>=0.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (0.8.2)
    Requirement already satisfied: plac<1.2.0,>=0.9.6 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (1.1.3)
    Requirement already satisfied: murmurhash<1.1.0,>=0.28.0 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (1.0.5)
    Requirement already satisfied: srsly<1.1.0,>=1.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (1.0.5)
    Requirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (57.4.0)
    Requirement already satisfied: thinc==7.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy<4->fastai) (7.4.0)
    Requirement already satisfied: importlib-metadata>=0.20 in /usr/local/lib/python3.7/dist-packages (from catalogue<1.1.0,>=0.0.7->spacy<4->fastai) (4.8.1)
    Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from importlib-metadata>=0.20->catalogue<1.1.0,>=0.0.7->spacy<4->fastai) (3.6.0)
    Requirement already satisfied: typing-extensions>=3.6.4 in /usr/local/lib/python3.7/dist-packages (from importlib-metadata>=0.20->catalogue<1.1.0,>=0.0.7->spacy<4->fastai) (3.7.4.3)
    Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests->fastai) (2.10)
    Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests->fastai) (3.0.4)
    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests->fastai) (2021.5.30)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests->fastai) (1.24.3)
    Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,>=2.0.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib->fastai) (2.4.7)
    Requirement already satisfied: kiwisolver>=1.0.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib->fastai) (1.3.2)
    Requirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.7/dist-packages (from matplotlib->fastai) (0.10.0)
    Requirement already satisfied: python-dateutil>=2.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib->fastai) (2.8.2)
    Requirement already satisfied: six in /usr/local/lib/python3.7/dist-packages (from cycler>=0.10->matplotlib->fastai) (1.15.0)
    Requirement already satisfied: pytz>=2017.2 in /usr/local/lib/python3.7/dist-packages (from pandas->fastai) (2018.9)
    Requirement already satisfied: joblib>=0.11 in /usr/local/lib/python3.7/dist-packages (from scikit-learn->fastai) (1.0.1)
    


```python
from fastai.vision.all import *
```

### ë°ì´í„°ì €ì¥, ë°ì´í„°ë¡œë”ìŠ¤ ìƒì„±í›„ dlsë¡œ ì €ì¥ 


```python
path=untar_data(URLs.PETS)/'images' # ì›¹ì—ì„œ ë‹¤ìš´ ë°›ëŠ”ê²ƒ. / ì½”ë©ì—ì„œëŠ” ê°€ìƒí´ë”ì— ì €ì¥í•˜ëŠ” ê²ƒ ê°™ìŒ. 
```



<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='811712512' class='' max='811706944' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [811712512/811706944 00:50<00:00]
</div>




```python
files=get_image_files(path) # ì´ë¯¸ì§€íŒŒì¼ë“¤ì˜ ì´ë¦„ì„ ëª¨ë‘ ë³µë¶™í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“ ë’¤ì— files.txtë¡œ ì €ì¥í•˜ëŠ” ê³¼ì •
```


```python
files[2] # txt íŒŒì¼ì˜ 3ë²ˆì§¸ ëª©ë¡
```

íŒŒì¼ ì´ë¦„ì˜ ì²«ê¸€ìê°€ ëŒ€ë¬¸ìë©´ ê³ ì–‘ì´ ì†Œë¬¸ìë©´ ê°•ì•„ì§€ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.


```python
def label_func(f):
    if f[0].isupper():
        return 'cat' 
    else: 
        return 'dog' 
```


```python
label_func('asdf') 
```


```python
dls=ImageDataLoaders.from_name_func(path,files,label_func,item_tfms=Resize(244)) #ë°ì´í„°ë“¤ì„ ë¶„ë¥˜ ë¶„ì„í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜. 
```

ImageDataLaoders (ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” í•¨ìˆ˜)  
.from_name_func(ì´ë¦„ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê² ë‹¤.)  
ì•ˆì—ëŠ” í•„ìš”í•œ ì¡°ê±´ë“¤ì„ ì±„ìš°ëŠ”ê²ƒ 

path ê²½ë¡œ / íŒŒì¼ë“¤ ì´ë¦„ / í•¨ìˆ˜ / ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ì •ë¦¬


```python
dls.show_batch(max_n=16)
```

### í•™ìŠµ


```python
learn = cnn_learner(dls,resnet34,metrics=error_rate)
```

`-` ì—ëŸ¬ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ë¥¼ ì„¤ì¹˜í•˜ë©´ ëœë‹¤. 


```python
# !conda install -c conda-forge jupyterlab_widgets -y 
# !conda install -c conda-forge ipywidgets -y 
# !conda install -c conda-forge nodejs -y 
```

`-` ìœ„ë¥¼ ì„¤ì¹˜í•˜ê³  ì»¤ë„ì„ ì¬ì‹œì‘í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ëª¨í˜•ì´ ë§Œë“¤ì–´ì§„ë‹¤. 


```python
learn=cnn_learner(dls,resnet34,metrics=error_rate)
```


```python
learn.fine_tune(1)
```


<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.144466</td>
      <td>0.020612</td>
      <td>0.008119</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table>



<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.062860</td>
      <td>0.018618</td>
      <td>0.005413</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table>


### ì˜ˆì¸¡


```python
learn.predict(files[0])
```








    ('dog', tensor(1), tensor([2.4075e-07, 1.0000e+00]))




```python
learn.show_results()
```






    
![png](output_24_1.png)
    


### ì˜¤ë‹µë¶„ì„ 


```python
interp = Interpretation.from_learner(learn)
```






```python
interp.plot_top_losses(16)
```


    
![png](output_27_0.png)
    


### ì§„ì§œ ì˜ë˜ëŠ”ê²Œ ë§ëŠ”ê±´ê°€? 


```python
PILImage.create('2021-09-06-cat1.png')
```




    
![png](output_29_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-cat1.png'))
```








    ('cat', tensor(0), tensor([1.0000e+00, 1.0442e-07]))



`-` í—·ê°ˆë¦¬ëŠ” ê³ ì–‘ì´ ì‚¬ì§„ì¸ë° ì˜ êµ¬ë¶„í•œë‹¤. 


```python
PILImage.create('2021-09-06-cat2.jpeg')
```




    
![png](output_32_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-cat2.jpeg'))
```








    ('cat', tensor(0), tensor([1.0000e+00, 3.3645e-06]))




```python
PILImage.create('2021-09-06-hani01.jpeg')
```




    
![png](output_34_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani01.jpeg'))
```








    ('dog', tensor(1), tensor([3.1670e-06, 1.0000e+00]))




```python
PILImage.create('2021-09-06-hani02.jpeg')
```




    
![png](output_36_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani02.jpeg'))
```








    ('dog', tensor(1), tensor([8.1501e-06, 9.9999e-01]))




```python
PILImage.create('2021-09-06-hani03.jpg')
```




    
![png](output_38_0.png)
    




```python
learn.predict(PILImage.create('2021-09-06-hani03.jpg'))
```








    ('dog', tensor(1), tensor([0.0270, 0.9730]))



### ë‹¤ìŒì‹œê°„ 
- ì´ë¯¸ì§€ í¬ë¡¤ë§ --> ë°ì´í„°ì…‹íŠ¸ --> A,B êµ¬ë¶„í•˜ëŠ” ëª¨ë¸ 

### [ìˆ™ì œ](https://ieilms.jbnu.ac.kr/)
- ìœ„ì˜ ì‚¬ì§„ë“¤ ì´ì™¸ì— ì‚¬ì§„ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì˜ˆì¸¡ì„ í•˜ëŠ” ëª¨í˜•êµ¬ì¶•. 
- ì˜ˆì¸¡ê²°ê³¼ë¥¼ ìŠ¤ìƒ·ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì œì¶œ (ì´ë¯¸ì§€ë„ í•¨ê»˜ ìŠ¤ìƒ·í• ê²ƒ) 

### ìˆ™ì œì°¸ê³ ìë£Œ 


```python
import PIL 
urls='https://t1.daumcdn.net/cfile/tistory/9925F03C5AD486B033'
urllib.request.urlretrieve(urls,'temp.png')
learn.predict(PILImage.create('temp.png'))
```








    ('dog', tensor(1), tensor([0.0091, 0.9909]))




```python
jupyter nbconvert --to markdown [2021-11-06-cnn ì´ë¯¸ì§€ ë¶„ë¥˜ë¶„ì„].
```
